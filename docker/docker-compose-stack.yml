version: "3.5"

services:
  netricservice:
    image: dockerhub.aereus.com/netric:${APPLICATION_VER}
    networks:
      - service_netric
      - default
    environment:
      APPLICATION_ENV: ${APPLICATION_ENV}
      APPLICATION_VER: ${APPLICATION_VER}
    ports:
      - 10001:80
    secrets:
      - auth_private_key
      - entityenc
    deploy:
      replicas: 2
      placement:
        constraints:
          - node.role!=manager
      update_config:
        parallelism: 1
        delay: 1s
        order: start-first

  netric_daemon:
    image: dockerhub.aereus.com/netric:${APPLICATION_VER}
    entrypoint: /start-daemon.sh
    environment:
      APPLICATION_ENV: ${APPLICATION_ENV}
      APPLICATION_VER: daemon-${APPLICATION_VER}
    secrets:
      - auth_private_key
      - entityenc
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role!=manager
      update_config:
        parallelism: 1
        delay: 1s
        order: start-first

networks:
  default:
    external: false
  service_netric:
    external: true

secrets:
  entityenc:
    file: /var/aereusdata/secrets/netric/entityenc
  auth_private_key:
    file: /var/aereusdata/secrets/netric/auth_private_key