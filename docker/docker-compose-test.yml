version: "2"
services:
  netric_server:
    build: ../
    environment:
      APPLICATION_ENV: testing
    volumes:
      - "../.reports:/var/www/html/.reports"
    depends_on:
      - memcached
      - gearmand
      - mail
      - db1
      - mogilefs
      - mogilestore
    entrypoint: 'bash -c "/netric-setup.sh && /netric-tests.sh > /dev/stdout"'
    logging:
      driver: "json-file"
  memcached:
    image: memcached
  gearmand:
    image: kendu/gearman
    depends_on:
      - memcached

  db1:
    image: "dockerhub.aereus.com/pgsql:latest"
    command:
      [
        "-c",
        "shared_buffers=256MB",
        "-c",
        "max_connections=200",
        "-c",
        "synchronous_commit=off",
        "-c",
        "fsync=off",
        "-c",
        "full_page_writes=off",
      ]
    environment:
      POSTGRES_USER: vagrant
      POSTGRES_PASSWORD: vagrant
    logging:
      driver: "json-file"
  mail:
    image: "dockerhub.aereus.com/mail:latest"
    environment:
      APP_HOST: netric.com
      DB_USER: vagrant
      DB_PASSWORD: vagrant
      DB_HOST: db1
      DB_NAME: antsystem
      DB_PORT: 5432
    depends_on:
      - db1
    logging:
      driver: "json-file"
  mogilefs:
    image: "dockerhub.aereus.com/mogiletracker:latest"
    environment:
      DB_USER: vagrant
      DB_PASSWORD: vagrant
      DB_HOST: mogiledb
      DB_NAME: mogilefs
      DB_PORT: 5432
      DB_INIT: "true"
      INIT_STORAGE_HOST: mogilestore
      WAIT_FOR_DB_TIMEOUT: 480
    depends_on:
      - mogilestore
      - mogiledb
    logging:
      driver: "json-file"

  mogiledb:
    image: postgres:10
    environment:
      POSTGRES_USER: vagrant
      POSTGRES_PASSWORD: vagrant

  mogilestore:
    image: "dockerhub.aereus.com/mogilestore:latest"
    logging:
      driver: "json-file"
